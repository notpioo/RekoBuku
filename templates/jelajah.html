{% extends "base.html" %}

{% block title %}Jelajah Buku - RekoBuku{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="fas fa-search text-primary me-2"></i>Jelajah Buku
                </h1>
            </div>
            
            <p class="text-muted mb-4">Temukan semua koleksi buku yang tersedia dan tambahkan ke favorit Anda.</p>
            
            <!-- Panel Input NLP -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-robot text-primary me-2"></i>Tanya AI untuk Rekomendasi Buku
                    </h5>
                    <p class="text-muted mb-3">Tanyakan kepada AI tentang buku yang Anda cari berdasarkan genre, tema, mood, atau kriteria lainnya.</p>
                    
                    <!-- Contoh Pertanyaan -->
                    <div class="mb-3">
                        <small class="text-muted">Contoh pertanyaan:</small><br>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 mb-1 example-query" data-query="Buku motivasi untuk anak muda">Buku motivasi untuk anak muda</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 mb-1 example-query" data-query="Novel romance yang ringan dan menghibur">Novel romance ringan</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 mb-1 example-query" data-query="Buku tentang algoritma dan pemrograman">Buku algoritma</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 mb-1 example-query" data-query="Cerita petualangan yang seru">Cerita petualangan</button>
                        </div>
                    </div>
                    
                    <form id="nlp-search-form" class="mb-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="input-group">
                            <input type="text" class="form-control" id="nlp-query" name="query" 
                                   placeholder="Contoh: 'Buku motivasi untuk anak muda', 'Novel romance yang ringan', 'Buku tentang algoritma', atau 'Cerita petualangan yang seru'" 
                                   required>
                            <button class="btn btn-primary" type="submit" id="nlp-search-btn">
                                <i class="fas fa-search me-2"></i>Cari dengan AI
                            </button>
                        </div>
                    </form>
                    
                    <div id="nlp-loading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Memproses...</span>
                        </div>
                        <p class="mt-2 text-muted">AI sedang mencari rekomendasi terbaik untuk Anda...</p>
                    </div>
                </div>
            </div>
            
            <!-- Area Rekomendasi Hasil NLP -->
            <div id="nlp-results" class="mb-4" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb text-warning me-2"></i>Rekomendasi AI
                        </h5>
                        <button type="button" class="btn-close" id="close-nlp-results" aria-label="Close"></button>
                    </div>
                    <div class="card-body">
                        <div id="nlp-explanation" class="alert alert-info mb-3"></div>
                        <div class="row" id="nlp-books-grid"></div>
                    </div>
                </div>
                
                <!-- Buku Serupa -->
                <div id="similar-books-section" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-copy text-info me-2"></i>Buku Serupa Lainnya
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="similar-books-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// JavaScript untuk contoh pertanyaan
document.querySelectorAll('.example-query').forEach(button => {
    button.addEventListener('click', function() {
        const query = this.getAttribute('data-query');
        document.getElementById('nlp-query').value = query;
    });
});

// JavaScript untuk fitur NLP
document.getElementById('nlp-search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const query = document.getElementById('nlp-query').value.trim();
    if (!query) {
        alert('Mohon masukkan pertanyaan Anda');
        return;
    }
    
    // Show loading
    document.getElementById('nlp-loading').style.display = 'block';
    document.getElementById('nlp-results').style.display = 'none';
    document.getElementById('nlp-search-btn').disabled = true;
    
    // Create timeout promise
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Request timeout')), 30000); // 30 second timeout
    });
    
    // Send request to backend with timeout
    Promise.race([
        fetch('/nlp-recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ query: query })
        }),
        timeoutPromise
    ])
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data received:', data); // Debug log
        
        document.getElementById('nlp-loading').style.display = 'none';
        document.getElementById('nlp-search-btn').disabled = false;
        
        if (data.error) {
            console.error('Server error:', data.error);
            // Show user-friendly error message
            displayErrorMessage('Maaf, layanan AI sedang tidak tersedia. Silakan coba lagi dalam beberapa saat.');
            return;
        }
        
        // Show results with a small delay to ensure DOM is ready
        console.log('Calling displayNLPResults with data:', data); // Debug log
        setTimeout(() => {
            displayNLPResults(data);
        }, 100);
    })
    .catch(error => {
        console.error('Fetch error:', error);
        document.getElementById('nlp-loading').style.display = 'none';
        document.getElementById('nlp-search-btn').disabled = false;
        
        // Show user-friendly error message instead of alert
        displayErrorMessage('Koneksi bermasalah. Silakan periksa koneksi internet Anda dan coba lagi.');
    });
});

function displayErrorMessage(message) {
    const resultsDiv = document.getElementById('nlp-results');
    const explanationDiv = document.getElementById('nlp-explanation');
    const booksGrid = document.getElementById('nlp-books-grid');
    
    // Show error message in results area
    explanationDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
    explanationDiv.className = 'alert alert-warning mb-3';
    booksGrid.innerHTML = '';
    resultsDiv.style.display = 'block';
    
    // Hide similar books section
    document.getElementById('similar-books-section').style.display = 'none';
}

function displayNLPResults(data) {
    console.log('displayNLPResults called with:', data); // Debug
    
    const resultsDiv = document.getElementById('nlp-results');
    let explanationDiv = document.getElementById('nlp-explanation');
    const booksGrid = document.getElementById('nlp-books-grid');
    
    console.log('Elements found:', {resultsDiv, explanationDiv, booksGrid}); // Debug
    
    // If explanationDiv is null, try to find it within resultsDiv
    if (!explanationDiv && resultsDiv) {
        explanationDiv = resultsDiv.querySelector('#nlp-explanation');
        console.log('Retried finding explanationDiv:', explanationDiv); // Debug
    }
    
    // Check if elements exist before manipulating them
    if (!resultsDiv || !explanationDiv || !booksGrid) {
        console.error('Required DOM elements not found:', {
            resultsDiv: !!resultsDiv,
            explanationDiv: !!explanationDiv,
            booksGrid: !!booksGrid
        });
        
        // Try to create missing elements if resultsDiv exists
        if (resultsDiv && !explanationDiv) {
            const cardBody = resultsDiv.querySelector('.card-body');
            if (cardBody) {
                const newExplanationDiv = document.createElement('div');
                newExplanationDiv.id = 'nlp-explanation';
                newExplanationDiv.className = 'alert alert-info mb-3';
                cardBody.insertBefore(newExplanationDiv, cardBody.firstChild);
                explanationDiv = newExplanationDiv;
                console.log('Created new explanationDiv:', explanationDiv); // Debug
            }
        }
        
        if (!explanationDiv) {
            console.error('Still cannot find or create explanationDiv');
            return;
        }
    }
    
    // Reset alert class
    explanationDiv.className = 'alert alert-info mb-3';
    
    // Show explanation
    explanationDiv.innerHTML = data.explanation || 'Berikut adalah rekomendasi buku berdasarkan pertanyaan Anda:';
    
    // Clear and populate books grid
    booksGrid.innerHTML = '';
    
    if (data.books && data.books.length > 0) {
        console.log('Processing books:', data.books); // Debug
        data.books.forEach(book => {
            console.log('Creating card for book:', book); // Debug
            const bookCard = createBookCard(book, data.reasons ? data.reasons[book.id] : null);
            console.log('Book card created:', bookCard); // Debug
            booksGrid.appendChild(bookCard);
        });
        
        // Force display and scroll to results
        resultsDiv.style.display = 'block';
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('Results div should be visible now'); // Debug
        
        // Show similar books if available
        if (data.similar_books && data.similar_books.length > 0) {
            displaySimilarBooks(data.similar_books);
        }
    } else {
        console.log('No books found in response'); // Debug
        explanationDiv.innerHTML = 'Maaf, tidak ditemukan buku yang sesuai dengan kriteria Anda. Silakan coba dengan kata kunci yang berbeda.';
        resultsDiv.style.display = 'block';
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function displaySimilarBooks(similarBooks) {
    const similarSection = document.getElementById('similar-books-section');
    const similarGrid = document.getElementById('similar-books-grid');
    
    similarGrid.innerHTML = '';
    
    similarBooks.forEach(book => {
        const bookCard = createBookCard(book);
        similarGrid.appendChild(bookCard);
    });
    
    similarSection.style.display = 'block';
}

function createBookCard(book, reason = null) {
    console.log('Creating book card for:', book.judul, 'with reason:', reason); // Debug
    
    const col = document.createElement('div');
    col.className = 'col-lg-3 col-md-4 col-sm-6 mb-4';
    
    const isFavorite = book.is_favorite || false;
    const favoriteIcon = isFavorite ? 'fas' : 'far';
    
    // Safely handle tags
    let tagsHtml = '';
    if (book.tag) {
        if (Array.isArray(book.tag)) {
            tagsHtml = book.tag.map(tag => `<span class="badge bg-secondary me-1">${tag.trim()}</span>`).join('');
        } else if (typeof book.tag === 'string') {
            tagsHtml = book.tag.split(',').map(tag => `<span class="badge bg-secondary me-1">${tag.trim()}</span>`).join('');
        }
    }
    
    col.innerHTML = `
        <div class="card h-100 book-card">
            ${book.foto ? 
                `<img src="${book.foto}" class="card-img-top book-cover" alt="${book.judul || 'Book cover'}" style="height: 250px; object-fit: cover;">` :
                `<div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 250px;"><i class="fas fa-book fa-3x text-muted"></i></div>`
            }
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">${book.judul || 'Judul tidak tersedia'}</h5>
                <p class="card-text text-muted">${book.penulis || 'Penulis tidak diketahui'}</p>
                ${tagsHtml ? `<div class="genres mb-3">${tagsHtml}</div>` : ''}
                ${reason ? `<div class="alert alert-light small mb-2"><i class="fas fa-info-circle me-1"></i>${reason}</div>` : ''}
                <p class="card-text small text-muted flex-grow-1">${book.deskripsi_singkat ? (book.deskripsi_singkat.length > 100 ? book.deskripsi_singkat.substring(0, 100) + '...' : book.deskripsi_singkat) : 'Tidak ada deskripsi tersedia.'}</p>
                <div class="mt-auto">
                    <div class="d-flex gap-2">
                        <a href="/book/${book.id}" class="btn btn-outline-primary flex-fill">
                            <i class="fas fa-eye me-1"></i>Lihat
                        </a>
                        ${book.show_favorite_btn !== false ? `
                            <button onclick="toggleFavorite('${book.id}')" class="btn btn-outline-danger book-favorite-btn" data-book-id="${book.id}">
                                <i class="${favoriteIcon} fa-heart"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    console.log('Book card HTML created successfully'); // Debug
    return col;
}

// Close NLP results
document.getElementById('close-nlp-results').addEventListener('click', function() {
    document.getElementById('nlp-results').style.display = 'none';
    document.getElementById('similar-books-section').style.display = 'none';
});
</script>
{% endblock %}